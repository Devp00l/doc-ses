<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<!-- Converted by suse-upgrade version 1.1 -->
<!-- influenced by http://ceph.com/docs/master/install/upgrading-ceph/ -->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha.ceph.upgrade">
 <title>Upgrading from Previous Releases</title>
 <info/>
 <para>
  This chapter introduces steps to upgrade &storage; from the previous
  release to the current one.
 </para>
 <sect1 xml:id="ceph.upgrade.general">
  <title>General Upgrade Procedure</title>

  <para>
   Before upgrading the &ceph; cluster itself, you need to add a new
   version of the &storage; product to the existing operating system, and
   update the software to the latest versions on each cluster node. You can
   upgrade daemons in your cluster while the cluster is online and in
   service. Certain types of daemons depend upon others. For example
   &ceph; &rgw;s depend upon &ceph; monitors and &ceph; OSD
   daemons. We recommend upgrading in this order:
  </para>

  <orderedlist spacing="normal">
   <listitem>
    <para>
     &ceph; monitors.
    </para>
   </listitem>
   <listitem>
    <para>
     &ceph; OSD daemons.
    </para>
   </listitem>
   <listitem>
    <para>
     &ceph; &rgw;s.
    </para>
   </listitem>
  </orderedlist>

  <tip>
   <para>
    We recommend upgrading all the daemons of a specific type&mdash;for
    example all monitor daemons or all OSD daemons&mdash;one by one to
    ensure that they are all on the same release. We also recommend that you
    upgrade all the daemons in your cluster before you try to exercise new
    functionality in a release.
   </para>
   <para>
    After all the daemons of a specific type are upgraded, check their
    status.
   </para>
   <para>
    Ensure each monitor has rejoined the quorum after all monitors are
    upgraded:
   </para>
<screen>ceph mon stat</screen>
   <para>
    Ensure each &ceph; OSD daemon has rejoined the cluster after all OSDs
    are upgraded:
   </para>
<screen>ceph osd stat</screen>
  </tip>

  <procedure>
   <step>
    <para>
     Check that the latest patches are applied to the installed &sls;.
    </para>
<screen>sudo zypper ref &amp;&amp; sudo zypper patch</screen>
   </step>
   <step>
    <para>
     Install &storage; extension with
     <menuchoice><guimenu>&yast;</guimenu><guimenu>Software</guimenu><guimenu>Add-On
     Products</guimenu><guimenu>Add</guimenu></menuchoice>.
    </para>
   </step>
   <step>
    <para>
     After the new product is added, refresh the installed software
     repositories.
    </para>
<screen>sudo zypper ref</screen>
   </step>
   <step>
    <para>
     Upgrade the installed software to the new version.
    </para>
<screen>sudo zypper dup</screen>
   </step>
   <step>
    <para>
     After the last &ceph; node is upgraded, check the cluster status.
    </para>
<screen>ceph health</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph.upgrade.1to2">
  <title>Upgrade from &storage; 1.0 to 2</title>

  <para>
   This section includes steps specific to upgrading &storage; version
   1.0 to 2.
  </para>

  <sect2 xml:id="ceph.upgrade.apache2civetweb">
   <title>Apache to Civetweb Migration</title>
   <para>
    While &storage; 1.0 used Apache as an application server for &rgw;
    client/server communication, &storage; 2 introduced a new application
    server called Civetweb. Civetweb is a lightweight embedded Web server,
    which makes &rgw; configuration easier.
   </para>
   <para>
    Although &rgw; in &storage; 2 still works well with Apache,
    support for Apache will end in future &storage; releases. To migrate
    your existing Apache to Civetweb, follow these steps:
   </para>
   <procedure>
    <step>
     <para>
      Check if Apache is running on your system:
     </para>
<screen>sudo systemctl status apache2.service</screen>
    </step>
    <step>
     <para>
      Stop Apache if it is running:
     </para>
<screen>sudo systemctl stop apache2.service</screen>
    </step>
    <step>
     <para>
      Disable Apache automatic start:
     </para>
<screen>sudo systemctl disable apache2.service</screen>
    </step>
    <step>
     <para>
      Edit <filename>/etc/ceph/ceph.conf</filename> and add the following
      lines:
     </para>
<screen>[client.radosgw.gateway]
rgw frontends = "civetweb port=80"</screen>
    </step>
    <step>
     <para>
      Restart &rgw;:
     </para>
<screen>sudo systemctl restart ceph-radosgw@<replaceable>gateway_name</replaceable>.service</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
